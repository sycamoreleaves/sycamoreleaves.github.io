<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="RTMP," />










<meta name="description" content="RTMP_Connect librtmp用RTMP_Connect这个方法建立网络连接，网络连接代表了服务端应用程序和客户端之间基本的连通关系。 在RTMP_ParseURL方法中， 可以通过传入的url解出来host、port、application用解出来的host和port建立socket，然后做一些rtmp握手之类的工作。">
<meta name="keywords" content="RTMP">
<meta property="og:type" content="article">
<meta property="og:title" content="RTMP网络连接分析">
<meta property="og:url" content="http://yoursite.com/2018/08/05/RTMP网络连接分析/index.html">
<meta property="og:site_name" content="sycamoreleaves.github.io">
<meta property="og:description" content="RTMP_Connect librtmp用RTMP_Connect这个方法建立网络连接，网络连接代表了服务端应用程序和客户端之间基本的连通关系。 在RTMP_ParseURL方法中， 可以通过传入的url解出来host、port、application用解出来的host和port建立socket，然后做一些rtmp握手之类的工作。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-08-05T15:34:19.808Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RTMP网络连接分析">
<meta name="twitter:description" content="RTMP_Connect librtmp用RTMP_Connect这个方法建立网络连接，网络连接代表了服务端应用程序和客户端之间基本的连通关系。 在RTMP_ParseURL方法中， 可以通过传入的url解出来host、port、application用解出来的host和port建立socket，然后做一些rtmp握手之类的工作。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/08/05/RTMP网络连接分析/"/>





  <title>RTMP网络连接分析 | sycamoreleaves.github.io</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">sycamoreleaves.github.io</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/05/RTMP网络连接分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="le.zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sycamoreleaves.github.io">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RTMP网络连接分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-05T22:41:34+08:00">
                2018-08-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/RTMP/" itemprop="url" rel="index">
                    <span itemprop="name">RTMP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="RTMP-Connect"><a href="#RTMP-Connect" class="headerlink" title="RTMP_Connect"></a>RTMP_Connect</h1><blockquote>
<p>librtmp用RTMP_Connect这个方法建立网络连接，网络连接代表了服务端应用程序和客户端之间基本的连通关系。 在<code>RTMP_ParseURL</code>方法中， 可以通过传入的url解出来<code>host</code>、<code>port</code>、<code>application</code><br>用解出来的host和port建立socket，然后做一些rtmp握手之类的工作。</p>
</blockquote>
<a id="more"></a>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">RTMP_Connect(RTMP *r, RTMPPacket *cp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">service</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (!r-&gt;Link.hostname.av_len)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;service, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_in));</span><br><span class="line">    service.sin_family = AF_INET;</span><br><span class="line">    RTMP_Log(RTMP_LOGDEBUG, <span class="string">"Link.sockport = %d"</span>, r-&gt;Link.sockshost);</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;Link.socksport) &#123;</span><br><span class="line">        <span class="comment">/* Connect via SOCKS */</span></span><br><span class="line">        <span class="keyword">if</span> (!add_addr_info(&amp;service, &amp;r-&gt;Link.sockshost, r-&gt;Link.socksport))</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        RTMP_Log(RTMP_LOGDEBUG, <span class="string">"hostname: %s, port = %d\n"</span>, r-&gt;Link.hostname.av_val, r-&gt;Link.port);</span><br><span class="line">        <span class="comment">/* Connect directly */</span></span><br><span class="line">        <span class="keyword">if</span> (!add_addr_info(&amp;service, &amp;r-&gt;Link.hostname, r-&gt;Link.port))</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建socket， 设置一些参数， 接收数据超时时间，禁用Nagle算法 </span></span><br><span class="line">    <span class="keyword">if</span> (!RTMP_Connect0(r, (struct sockaddr *)&amp;service))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    r-&gt;m_bSendCounter = TRUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RTMP_Connect1(r, cp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="RTMP-Connect0"><a href="#RTMP-Connect0" class="headerlink" title="RTMP_Connect0"></a>RTMP_Connect0</h2><blockquote>
<p><code>RTMP_Connect0</code>方法中主要就是创建tcp socket， 然后连接服务器， 设置超时， 禁用Nagle算法<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">RTMP_Connect0(RTMP *r, struct sockaddr * service)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    r-&gt;m_sb.sb_timedout = FALSE;</span><br><span class="line">    r-&gt;m_pausing = <span class="number">0</span>;</span><br><span class="line">    r-&gt;m_fDuration = <span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line">    r-&gt;m_sb.sb_socket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;m_sb.sb_socket != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (connect(r-&gt;m_sb.sb_socket, service, <span class="keyword">sizeof</span>(struct sockaddr)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> err = GetSockError();</span><br><span class="line">            RTMP_Log(RTMP_LOGERROR, <span class="string">"%s, failed to connect socket. %d (%s)"</span>,</span><br><span class="line">            __FUNCTION__, err, strerror(err));</span><br><span class="line">            RTMP_Close(r);</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;Link.socksport) &#123;</span><br><span class="line">            RTMP_Log(RTMP_LOGDEBUG, <span class="string">"%s ... SOCKS negotiation"</span>, __FUNCTION__);</span><br><span class="line">            <span class="keyword">if</span> (!SocksNegotiate(r)) &#123;</span><br><span class="line">                RTMP_Log(RTMP_LOGERROR, <span class="string">"%s, SOCKS negotiation failed."</span>, __FUNCTION__);</span><br><span class="line">                RTMP_Close(r);</span><br><span class="line">                <span class="keyword">return</span> FALSE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        RTMP_Log(RTMP_LOGERROR, <span class="string">"%s, failed to create socket. Error: %d"</span>, __FUNCTION__,</span><br><span class="line">        GetSockError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set timeout */</span></span><br><span class="line">    &#123;</span><br><span class="line">        SET_RCVTIMEO(tv, r-&gt;Link.timeout);</span><br><span class="line">        <span class="keyword">if</span> (setsockopt</span><br><span class="line">        (r-&gt;m_sb.sb_socket, SOL_SOCKET, SO_RCVTIMEO, (<span class="keyword">char</span> *)&amp;tv, <span class="keyword">sizeof</span>(tv))) &#123;</span><br><span class="line">            RTMP_Log(RTMP_LOGERROR, <span class="string">"%s, Setting socket timeout to %ds failed!"</span>,</span><br><span class="line">            __FUNCTION__, r-&gt;Link.timeout);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 禁用Nagle算法， 保证了数据实时性</span></span><br><span class="line">    setsockopt(r-&gt;m_sb.sb_socket, IPPROTO_TCP, TCP_NODELAY, (<span class="keyword">char</span> *) &amp;on, <span class="keyword">sizeof</span>(on));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @remark debug info by http://github.com/ossrs/srs</span></span><br><span class="line">    _srs_state = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="RTMP-Connect1"><a href="#RTMP-Connect1" class="headerlink" title="RTMP_Connect1"></a>RTMP_Connect1</h2><blockquote>
<p><code>RTMP_Connect1</code>主要包括握手<code>(HandShake)</code>，还有向服务器发送连接命令<code>(SendConnectPacket)</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">RTMP_Connect1(RTMP *r, RTMPPacket *cp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;Link.protocol &amp; RTMP_FEATURE_SSL) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CRYPTO) &amp;&amp; !defined(NO_SSL)</span></span><br><span class="line">        TLS_client(RTMP_TLS_ctx, r-&gt;m_sb.sb_ssl);</span><br><span class="line">        TLS_setfd(r-&gt;m_sb.sb_ssl, r-&gt;m_sb.sb_socket);</span><br><span class="line">        <span class="keyword">if</span> (TLS_connect(r-&gt;m_sb.sb_ssl) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            RTMP_Log(RTMP_LOGERROR, <span class="string">"%s, TLS_Connect failed"</span>, __FUNCTION__);</span><br><span class="line">            RTMP_Close(r);</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        RTMP_Log(RTMP_LOGERROR, <span class="string">"%s, no SSL/TLS support"</span>, __FUNCTION__);</span><br><span class="line">        RTMP_Close(r);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    RTMP_Log(RTMP_LOGDEBUG, <span class="string">"Link.protocal: %d"</span>, r-&gt;Link.protocol);</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;Link.protocol &amp; RTMP_FEATURE_HTTP) &#123;</span><br><span class="line">        r-&gt;m_msgCounter = <span class="number">1</span>;</span><br><span class="line">        r-&gt;m_clientID.av_val = <span class="literal">NULL</span>;</span><br><span class="line">        r-&gt;m_clientID.av_len = <span class="number">0</span>;</span><br><span class="line">        HTTP_Post(r, RTMPT_OPEN, <span class="string">""</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (HTTP_read(r, <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            r-&gt;m_msgCounter = <span class="number">0</span>;</span><br><span class="line">            RTMP_Log(RTMP_LOGDEBUG, <span class="string">"%s, Could not connect for handshake"</span>, __FUNCTION__);</span><br><span class="line">            RTMP_Close(r);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        r-&gt;m_msgCounter = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    RTMP_Log(RTMP_LOGDEBUG, <span class="string">"%s, ... connected, handshaking"</span>, __FUNCTION__);</span><br><span class="line">    <span class="keyword">if</span> (!HandShake(r, TRUE)) &#123;</span><br><span class="line">        RTMP_Log(RTMP_LOGERROR, <span class="string">"%s, handshake failed."</span>, __FUNCTION__);</span><br><span class="line">        RTMP_Close(r);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    RTMP_Log(RTMP_LOGDEBUG, <span class="string">"%s, handshaked"</span>, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!SendConnectPacket(r, cp)) &#123;</span><br><span class="line">        RTMP_Log(RTMP_LOGERROR, <span class="string">"%s, RTMP connect failed."</span>, __FUNCTION__);</span><br><span class="line">        RTMP_Close(r);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="HandShake"><a href="#HandShake" class="headerlink" title="HandShake"></a>HandShake</h3><blockquote>
<p>一个RTMP连接以握手开始， RTMP的握手不同以其他协议：RTMP握手由三个固定长度的块组成，而不像其他协议一样带有报头的可变长度的块。客户端和服务端各自发送三块数据， </p>
<ul>
<li>客户端：C0、C1、C2</li>
<li>服务端：S0、S1、S2</li>
</ul>
</blockquote>
<p>下面时librtmp中对于握手的处理<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">HandShake(RTMP *r, <span class="keyword">int</span> FP9HandShake)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">uint32_t</span> uptime, suptime;</span><br><span class="line">    <span class="keyword">int</span> bMatch;</span><br><span class="line">    <span class="keyword">char</span> type;</span><br><span class="line">    <span class="keyword">char</span> clientbuf[RTMP_SIG_SIZE + <span class="number">1</span>], *clientsig = clientbuf + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> serversig[RTMP_SIG_SIZE];</span><br><span class="line"></span><br><span class="line">    clientbuf[<span class="number">0</span>] = <span class="number">0x03</span>;		<span class="comment">/* not encrypted */</span></span><br><span class="line"></span><br><span class="line">    uptime = htonl(RTMP_GetTime());</span><br><span class="line">    <span class="built_in">memcpy</span>(clientsig, &amp;uptime, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;clientsig[<span class="number">4</span>], <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _DEBUG</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">8</span>; i &lt; RTMP_SIG_SIZE; i++)</span><br><span class="line">        clientsig[i] = <span class="number">0xff</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">8</span>; i &lt; RTMP_SIG_SIZE; i++)</span><br><span class="line">        clientsig[i] = (<span class="keyword">char</span>)(rand() % <span class="number">256</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 发送C0、C1数据块</span></span><br><span class="line">    <span class="keyword">if</span> (!WriteN(r, clientbuf, RTMP_SIG_SIZE + <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 接收S0块 */</span></span><br><span class="line">    <span class="keyword">if</span> (ReadN(r, &amp;type, <span class="number">1</span>) != <span class="number">1</span>)	<span class="comment">/* 0x03 or 0x06 */</span></span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    RTMP_Log(RTMP_LOGDEBUG, <span class="string">"%s: Type Answer   : %02X"</span>, __FUNCTION__, type);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type != clientbuf[<span class="number">0</span>])</span><br><span class="line">        RTMP_Log(RTMP_LOGWARNING, <span class="string">"%s: Type mismatch: client sent %d, server answered %d"</span>,</span><br><span class="line">                 __FUNCTION__, clientbuf[<span class="number">0</span>], type);</span><br><span class="line">    <span class="comment">/* 接收S1块 */</span></span><br><span class="line">    <span class="keyword">if</span> (ReadN(r, serversig, RTMP_SIG_SIZE) != RTMP_SIG_SIZE)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* decode server response */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;suptime, serversig, <span class="number">4</span>);</span><br><span class="line">    suptime = ntohl(suptime);</span><br><span class="line"></span><br><span class="line">    RTMP_Log(RTMP_LOGDEBUG, <span class="string">"%s: Server Uptime : %d"</span>, __FUNCTION__, suptime);</span><br><span class="line">    RTMP_Log(RTMP_LOGDEBUG, <span class="string">"%s: FMS Version   : %d.%d.%d.%d"</span>, __FUNCTION__,</span><br><span class="line">             serversig[<span class="number">4</span>], serversig[<span class="number">5</span>], serversig[<span class="number">6</span>], serversig[<span class="number">7</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2nd part of handshake 发送C2块*/</span></span><br><span class="line">    <span class="keyword">if</span> (!WriteN(r, serversig, RTMP_SIG_SIZE))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 接收S2块 */</span></span><br><span class="line">    <span class="keyword">if</span> (ReadN(r, serversig, RTMP_SIG_SIZE) != RTMP_SIG_SIZE)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    bMatch = (<span class="built_in">memcmp</span>(serversig, clientsig, RTMP_SIG_SIZE) == <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!bMatch) &#123;</span><br><span class="line">        RTMP_Log(RTMP_LOGWARNING, <span class="string">"%s, client signature does not match!"</span>, __FUNCTION__);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="握手顺序"><a href="#握手顺序" class="headerlink" title="握手顺序"></a>握手顺序</h4><p>握手的顺序大致可以描述如下</p>
<ul>
<li>客户端首先发送<code>C0</code>和<code>C1</code>块</li>
<li>服务端接收到<code>C0</code>或<code>C1</code>块之后，向客户端发送<code>S0</code>和<code>S1</code>块</li>
<li>客户端相继接收数据， 直到接收到<code>S1</code>数据块之后， 再服务端发送<code>C2</code>块</li>
<li>服务端必须等待接收到<code>C1</code>块之后才能发送<code>S2</code>块</li>
<li>客户端必须等待接收到<code>S2</code>块才能发送其他数据</li>
<li>服务端必须等待接收到<code>C1</code>块才能发送其他数据</li>
</ul>
<h4 id="握手数据块格式"><a href="#握手数据块格式" class="headerlink" title="握手数据块格式"></a>握手数据块格式</h4><blockquote>
<p>下面介绍一下C0、C1、C2和S0、S1、S2数据块的格式。</p>
</blockquote>
<h5 id="C0和S0数据块格式"><a href="#C0和S0数据块格式" class="headerlink" title="C0和S0数据块格式"></a>C0和S0数据块格式</h5><p>C0和S0块都是一个单一的八位字节，以一个单独的八位整形域进行处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> </span><br><span class="line">+-+-+-+-+-+-+-+-+</span><br><span class="line">|    version    |</span><br><span class="line">+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>
<h5 id="C1和S1的格式"><a href="#C1和S1的格式" class="headerlink" title="C1和S1的格式"></a>C1和S1的格式</h5><p>C1和S1的数据包的长度为1536字节， 包括以下字段<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span></span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                            time(<span class="number">4</span> bytes)                      |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                            zero(<span class="number">4</span> bytes)                      |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                            random bytes                       |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                            random bytes                       |</span><br><span class="line">|                              (<span class="keyword">const</span>)                          |</span><br><span class="line">|                                ...                            |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Time(四个字节)：这个字段包括了一个timestamp, 用于本终端发送的所有后续块的时间起点。这个值可以时0或者一些任意值。</li>
<li>Zero(四个字节)：这个字段必须时0</li>
<li>Random data(四个字节)：这个字段可以包含任意值</li>
</ul>
<h5 id="C2和S2的格式"><a href="#C2和S2的格式" class="headerlink" title="C2和S2的格式"></a>C2和S2的格式</h5><p>C2和S2数据包长度都是1536字节， 基本上就是S1和C1的副本， 包含以下字段：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span></span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                            time(<span class="number">4</span> bytes)                      |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                            time2(<span class="number">4</span> bytes)                     |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                            random echo                        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                            random echo                        |</span><br><span class="line">|                              (<span class="keyword">const</span>)                          |</span><br><span class="line">|                                ...                            |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Time(四个字节)：这个字段必须包含终端在S1(给C2)或者C1(给S2)发的timestamp</li>
<li>Time2(四个字节)：这个字段必须包含终端先前发出数据包(S1或者C1)timestamp</li>
<li>Random data(四个字节)：这个字段必须包含终端发出的S1(给C2)或者S2(给C1)的随机数。</li>
</ul>
<h3 id="SendConnectPacket"><a href="#SendConnectPacket" class="headerlink" title="SendConnectPacket"></a>SendConnectPacket</h3><p><code>SendConnectPacket</code>方法的作用是客户端发送<code>connect</code>命令到服务器端来请求连接到一个服务器应用的实例</p>
<p><code>connect</code>命令结构如下：<br>|            字段名                     |       类型          |                    描述                         |<br>|           :——-                     |     —–:          |                  :—–:                         |<br>|     Command Name           |     字符串        |      命令的名字，这里是connect    |<br>|      Transaction ID               |     数字            |     总是设置为1                             |<br>|    Command Object           |      对象           | 具有名值对的命令信息对象             |<br>| Optional User Arguments  |   对象            |   任意可选对象                       |</p>
<p>任意可选对象里面是相当与是一些用户参数， <code>app</code>、 <code>flashver</code>、<code>swfUrl</code>等</p>
<p>下面是librtmp中的连接代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">SendConnectPacket(RTMP *r, RTMPPacket *cp)</span><br><span class="line">&#123;</span><br><span class="line">    RTMPPacket packet;</span><br><span class="line">    <span class="keyword">char</span> pbuf[<span class="number">4096</span>], *pend = pbuf + <span class="keyword">sizeof</span>(pbuf);</span><br><span class="line">    <span class="keyword">char</span> *enc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cp)</span><br><span class="line">        <span class="keyword">return</span> RTMP_SendPacket(r, cp, TRUE);</span><br><span class="line"></span><br><span class="line">    packet.m_nChannel = <span class="number">0x03</span>;	<span class="comment">/* control channel (invoke) */</span></span><br><span class="line">    packet.m_headerType = RTMP_PACKET_SIZE_LARGE;</span><br><span class="line">    packet.m_packetType = RTMP_PACKET_TYPE_INVOKE;</span><br><span class="line">    packet.m_nTimeStamp = <span class="number">0</span>;</span><br><span class="line">    packet.m_nInfoField2 = <span class="number">0</span>;</span><br><span class="line">    packet.m_hasAbsTimestamp = <span class="number">0</span>;</span><br><span class="line">    packet.m_body = pbuf + RTMP_MAX_HEADER_SIZE;</span><br><span class="line"></span><br><span class="line">    enc = packet.m_body;</span><br><span class="line">    enc = AMF_EncodeString(enc, pend, &amp;av_connect);</span><br><span class="line">    enc = AMF_EncodeNumber(enc, pend, ++r-&gt;m_numInvokes);</span><br><span class="line">    *enc++ = AMF_OBJECT;</span><br><span class="line"></span><br><span class="line">    enc = AMF_EncodeNamedString(enc, pend, &amp;av_app, &amp;r-&gt;Link.app);</span><br><span class="line">    <span class="keyword">if</span> (!enc)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;Link.protocol &amp; RTMP_FEATURE_WRITE) &#123;</span><br><span class="line">        enc = AMF_EncodeNamedString(enc, pend, &amp;av_type, &amp;av_nonprivate);</span><br><span class="line">        <span class="keyword">if</span> (!enc)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;Link.flashVer.av_len) &#123;</span><br><span class="line">        enc = AMF_EncodeNamedString(enc, pend, &amp;av_flashVer, &amp;r-&gt;Link.flashVer);</span><br><span class="line">        <span class="keyword">if</span> (!enc)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;Link.swfUrl.av_len) &#123;</span><br><span class="line">        enc = AMF_EncodeNamedString(enc, pend, &amp;av_swfUrl, &amp;r-&gt;Link.swfUrl);</span><br><span class="line">        <span class="keyword">if</span> (!enc)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;Link.tcUrl.av_len) &#123;</span><br><span class="line">        enc = AMF_EncodeNamedString(enc, pend, &amp;av_tcUrl, &amp;r-&gt;Link.tcUrl);</span><br><span class="line">        <span class="keyword">if</span> (!enc)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(r-&gt;Link.protocol &amp; RTMP_FEATURE_WRITE)) &#123;</span><br><span class="line">        enc = AMF_EncodeNamedBoolean(enc, pend, &amp;av_fpad, FALSE);</span><br><span class="line">        <span class="keyword">if</span> (!enc)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        enc = AMF_EncodeNamedNumber(enc, pend, &amp;av_capabilities, <span class="number">15.0</span>);</span><br><span class="line">        <span class="keyword">if</span> (!enc)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        enc = AMF_EncodeNamedNumber(enc, pend, &amp;av_audioCodecs, r-&gt;m_fAudioCodecs);</span><br><span class="line">        <span class="keyword">if</span> (!enc)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        enc = AMF_EncodeNamedNumber(enc, pend, &amp;av_videoCodecs, r-&gt;m_fVideoCodecs);</span><br><span class="line">        <span class="keyword">if</span> (!enc)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        enc = AMF_EncodeNamedNumber(enc, pend, &amp;av_videoFunction, <span class="number">1.0</span>);</span><br><span class="line">        <span class="keyword">if</span> (!enc)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;Link.pageUrl.av_len) &#123;</span><br><span class="line">            enc = AMF_EncodeNamedString(enc, pend, &amp;av_pageUrl, &amp;r-&gt;Link.pageUrl);</span><br><span class="line">            <span class="keyword">if</span> (!enc)</span><br><span class="line">                <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;m_fEncoding != <span class="number">0.0</span> || r-&gt;m_bSendEncoding) &#123;</span><br><span class="line">        <span class="comment">/* AMF0, AMF3 not fully supported yet */</span></span><br><span class="line">        enc = AMF_EncodeNamedNumber(enc, pend, &amp;av_objectEncoding, r-&gt;m_fEncoding);</span><br><span class="line">        <span class="keyword">if</span> (!enc)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (enc + <span class="number">3</span> &gt;= pend)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    *enc++ = <span class="number">0</span>;</span><br><span class="line">    *enc++ = <span class="number">0</span>;			<span class="comment">/* end of object - 0x00 0x00 0x09 */</span></span><br><span class="line">    *enc++ = AMF_OBJECT_END;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add auth string */</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;Link.auth.av_len) &#123;</span><br><span class="line">        enc = AMF_EncodeBoolean(enc, pend, r-&gt;Link.lFlags &amp; RTMP_LF_AUTH);</span><br><span class="line">        <span class="keyword">if</span> (!enc)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        enc = AMF_EncodeString(enc, pend, &amp;r-&gt;Link.auth);</span><br><span class="line">        <span class="keyword">if</span> (!enc)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;Link.extras.o_num) &#123;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; r-&gt;Link.extras.o_num; i++) &#123;</span><br><span class="line">            enc = AMFProp_Encode(&amp;r-&gt;Link.extras.o_props[i], enc, pend);</span><br><span class="line">            <span class="keyword">if</span> (!enc)</span><br><span class="line">                <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    packet.m_nBodySize = enc - packet.m_body;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RTMP_SendPacket(r, &amp;packet, TRUE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/RTMP/" rel="tag"># RTMP</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/05/用户控制消息事件/" rel="next" title="用户控制消息事件">
                <i class="fa fa-chevron-left"></i> 用户控制消息事件
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/08/ffplay的FrameQueue分析/" rel="prev" title="ffplay的FrameQueue分析">
                ffplay的FrameQueue分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">le.zhang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/sycamoreleaves" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#RTMP-Connect"><span class="nav-number">1.</span> <span class="nav-text">RTMP_Connect</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RTMP-Connect0"><span class="nav-number">1.1.</span> <span class="nav-text">RTMP_Connect0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RTMP-Connect1"><span class="nav-number">1.2.</span> <span class="nav-text">RTMP_Connect1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HandShake"><span class="nav-number">1.2.1.</span> <span class="nav-text">HandShake</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#握手顺序"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">握手顺序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#握手数据块格式"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">握手数据块格式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#C0和S0数据块格式"><span class="nav-number">1.2.1.2.1.</span> <span class="nav-text">C0和S0数据块格式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#C1和S1的格式"><span class="nav-number">1.2.1.2.2.</span> <span class="nav-text">C1和S1的格式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#C2和S2的格式"><span class="nav-number">1.2.1.2.3.</span> <span class="nav-text">C2和S2的格式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SendConnectPacket"><span class="nav-number">1.2.2.</span> <span class="nav-text">SendConnectPacket</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">le.zhang</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
